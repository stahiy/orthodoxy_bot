<?php

namespace App\Model;

class CalendarModel
{
    public function __construct(
        private array $fixedHolidays
    ) {}

    /**
     * ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»Ð½Ð¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð´Ð½Ñ: Ð¿Ñ€Ð°Ð·Ð´Ð½Ð¸Ðº, Ð¿Ð¾ÑÑ‚, ÑÐµÐ´Ð¼Ð¸Ñ†Ð°.
     */
    public function getHoliday(string $date = 'now'): ?string
    {
        $dt = new \DateTime($date);
        $md = $dt->format('m-d');
        $year = (int)$dt->format('Y');

        $descriptionParts = [];

        // 1. Ð¡ÐµÐ´Ð¼Ð¸Ñ†Ð° Ð¸ Ð³Ð»Ð°Ñ
        $weekInfo = $this->getWeekInfo($dt, $year);
        if ($weekInfo) {
            $descriptionParts[] = $weekInfo;
        }

        // 2. ÐŸÐ¾ÑÑ‚ Ð¸ Ñ‚Ñ€Ð°Ð¿ÐµÐ·Ð°
        $fastInfo = $this->getFastInfo($dt, $year);
        if ($fastInfo) {
            $descriptionParts[] = $fastInfo;
        }

        // 3. ÐÐµÐ¿Ð¾Ð´Ð²Ð¸Ð¶Ð½Ñ‹Ðµ Ð¿Ñ€Ð°Ð·Ð´Ð½Ð¸ÐºÐ¸ (ÐœÐ¸Ð½ÐµÑ)
        if (isset($this->fixedHolidays[$md])) {
            $descriptionParts[] = "ðŸ—“ " . $this->fixedHolidays[$md];
        }

        // 4. ÐŸÐµÑ€ÐµÑ…Ð¾Ð´ÑÑ‰Ð¸Ðµ Ð¿Ñ€Ð°Ð·Ð´Ð½Ð¸ÐºÐ¸ (Ð¢Ñ€Ð¸Ð¾Ð´ÑŒ)
        $easterTs = $this->getOrthodoxEasterTimestamp($year);
        $currentTs = $dt->setTime(0, 0)->getTimestamp();
        $diffDays = round(($currentTs - $easterTs) / 86400);

        $movableHoliday = $this->getMovableHoliday($diffDays);
        if ($movableHoliday) {
            $descriptionParts[] = "ðŸ—“ " . $movableHoliday;
        }

        if (empty($descriptionParts)) {
            return null;
        }

        return implode("\n\n", $descriptionParts);
    }

    private function getMovableHoliday(float $diffDays): ?string
    {
        return match ((int)$diffDays) {
            -48 => 'ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð’ÐµÐ»Ð¸ÐºÐ¾Ð³Ð¾ Ð¿Ð¾ÑÑ‚Ð° (Ð§Ð¸ÑÑ‚Ñ‹Ð¹ Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº)',
            -7  => 'Ð’Ñ…Ð¾Ð´ Ð“Ð¾ÑÐ¿Ð¾Ð´ÐµÐ½ÑŒ Ð² Ð˜ÐµÑ€ÑƒÑÐ°Ð»Ð¸Ð¼ (Ð’ÐµÑ€Ð±Ð½Ð¾Ðµ Ð’Ð¾ÑÐºÑ€ÐµÑÐµÐ½ÑŒÐµ)',
            -3  => 'Ð’ÐµÐ»Ð¸ÐºÐ¸Ð¹ Ð§ÐµÑ‚Ð²ÐµÑ€Ð³ (Ð’Ð¾ÑÐ¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ðµ Ð¢Ð°Ð¹Ð½Ð¾Ð¹ Ð’ÐµÑ‡ÐµÑ€Ð¸)',
            -2  => 'Ð’ÐµÐ»Ð¸ÐºÐ°Ñ ÐŸÑÑ‚Ð½Ð¸Ñ†Ð° (Ð’Ð¾ÑÐ¿Ð¾Ð¼Ð¸Ð½Ð°Ð½Ð¸Ðµ Ð¡Ð²ÑÑ‚Ñ‹Ñ… ÑÐ¿Ð°ÑÐ¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… Ð¡Ñ‚Ñ€Ð°ÑÑ‚ÐµÐ¹ Ð“Ð¾ÑÐ¿Ð¾Ð´Ð½Ð¸Ñ…)',
            -1  => 'Ð’ÐµÐ»Ð¸ÐºÐ°Ñ Ð¡ÑƒÐ±Ð±Ð¾Ñ‚Ð°',
             0  => 'ÐŸÐ°ÑÑ…Ð° â€” Ð¡Ð²ÐµÑ‚Ð»Ð¾Ðµ Ð¥Ñ€Ð¸ÑÑ‚Ð¾Ð²Ð¾ Ð’Ð¾ÑÐºÑ€ÐµÑÐµÐ½Ð¸Ðµ',
             7  => 'ÐÐµÐ´ÐµÐ»Ñ 2-Ñ Ð¿Ð¾ ÐŸÐ°ÑÑ…Ðµ, ÐÐ½Ñ‚Ð¸Ð¿Ð°ÑÑ…Ð° (Ð¤Ð¾Ð¼Ð¸Ð½Ð° Ð½ÐµÐ´ÐµÐ»Ñ)',
             9  => 'Ð Ð°Ð´Ð¾Ð½Ð¸Ñ†Ð° (ÐŸÐ¾Ð¼Ð¸Ð½Ð¾Ð²ÐµÐ½Ð¸Ðµ ÑƒÑÐ¾Ð¿ÑˆÐ¸Ñ…)',
            14  => 'ÐÐµÐ´ÐµÐ»Ñ 3-Ñ Ð¿Ð¾ ÐŸÐ°ÑÑ…Ðµ, ÑÐ²ÑÑ‚Ñ‹Ñ… Ð¶ÐµÐ½-Ð¼Ð¸Ñ€Ð¾Ð½Ð¾ÑÐ¸Ñ†',
            39  => 'Ð’Ð¾Ð·Ð½ÐµÑÐµÐ½Ð¸Ðµ Ð“Ð¾ÑÐ¿Ð¾Ð´Ð½Ðµ',
            48  => 'Ð¢Ñ€Ð¾Ð¸Ñ†ÐºÐ°Ñ Ñ€Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÑÐºÐ°Ñ ÑÑƒÐ±Ð±Ð¾Ñ‚Ð°',
            49  => 'Ð”ÐµÐ½ÑŒ Ð¡Ð²ÑÑ‚Ð¾Ð¹ Ð¢Ñ€Ð¾Ð¸Ñ†Ñ‹ (ÐŸÑÑ‚Ð¸Ð´ÐµÑÑÑ‚Ð½Ð¸Ñ†Ð°)',
            50  => 'Ð”ÐµÐ½ÑŒ Ð¡Ð²ÑÑ‚Ð¾Ð³Ð¾ Ð”ÑƒÑ…Ð°',
            default => null,
        };
    }

    /**
     * ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ ÑÐµÐ´Ð¼Ð¸Ñ†Ñ‹ Ð¿Ð¾ ÐŸÑÑ‚Ð¸Ð´ÐµÑÑÑ‚Ð½Ð¸Ñ†Ðµ
     */
    private function getWeekInfo(\DateTime $dt, int $year): ?string
    {
        $easterTs = $this->getOrthodoxEasterTimestamp($year);
        $pentecostTs = $easterTs + (49 * 86400); // Ð¢Ñ€Ð¾Ð¸Ñ†Ð° = ÐŸÐ°ÑÑ…Ð° + 49 Ð´Ð½ÐµÐ¹
        $currentTs = $dt->setTime(0, 0)->getTimestamp();

        // Ð•ÑÐ»Ð¸ Ð´Ð°Ñ‚Ð° Ð¿Ð¾ÑÐ»Ðµ Ð¢Ñ€Ð¾Ð¸Ñ†Ñ‹
        if ($currentTs > $pentecostTs) {
            // Ð Ð°Ð·Ð½Ð¸Ñ†Ð° Ð² Ð´Ð½ÑÑ… Ñ Ð¢Ñ€Ð¾Ð¸Ñ†Ñ‹
            $diffPentecost = floor(($currentTs - $pentecostTs) / 86400);
            // Ð¡ÐµÐ´Ð¼Ð¸Ñ†Ð° Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ Ñ Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸ÐºÐ° Ð¿Ð¾ÑÐ»Ðµ Ð¢Ñ€Ð¾Ð¸Ñ†Ñ‹? ÐÐµÑ‚, ÑÑ‡ÐµÑ‚ Ð¸Ð´ÐµÑ‚ "Ð¿Ð¾ ÐŸÑÑ‚Ð¸Ð´ÐµÑÑÑ‚Ð½Ð¸Ñ†Ðµ".
            // Ð’Ð¾ÑÐºÑ€ÐµÑÐµÐ½ÑŒÐµ Ð¢Ñ€Ð¾Ð¸Ñ†Ñ‹ - ÑÑ‚Ð¾ 0-Ð¹ Ð´ÐµÐ½ÑŒ Ð¾Ñ‚ÑÑ‡ÐµÑ‚Ð°.
            // 1-Ñ ÑÐµÐ´Ð¼Ð¸Ñ†Ð° Ð¿Ð¾ ÐŸÑÑ‚Ð¸Ð´ÐµÑÑÑ‚Ð½Ð¸Ñ†Ðµ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ ÑÑ€Ð°Ð·Ñƒ.
            $weekNum = floor($diffPentecost / 7) + 1;
            
            // ÐžÐ³Ñ€Ð°Ð½Ð¸Ñ‡Ð¸Ð²Ð°ÐµÐ¼ Ð´Ð¾ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð’ÐµÐ»Ð¸ÐºÐ¾Ð³Ð¾ ÐŸÐ¾ÑÑ‚Ð° (Ð³Ñ€ÑƒÐ±Ð¾)
            if ($weekNum > 0 && $weekNum < 40) {
                return "Ð¡ÐµÐ´Ð¼Ð¸Ñ†Ð° {$weekNum}-Ñ Ð¿Ð¾ ÐŸÑÑ‚Ð¸Ð´ÐµÑÑÑ‚Ð½Ð¸Ñ†Ðµ.";
            }
        }
        
        return null;
    }

    /**
     * ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð¿Ð¾ÑÑ‚Ð° Ð¸ Ð¿Ñ€Ð°Ð²Ð¸Ð» Ñ‚Ñ€Ð°Ð¿ÐµÐ·Ñ‹
     */
    private function getFastInfo(\DateTime $dt, int $year): ?string
    {
        $md = $dt->format('m-d');
        $currentTs = $dt->setTime(0, 0)->getTimestamp();
        $easterTs = $this->getOrthodoxEasterTimestamp($year);
        $dayOfWeek = (int)$dt->format('N'); // 1 - ÐŸÐ½, 7 - Ð’Ñ

        // --- Ð Ð¾Ð¶Ð´ÐµÑÑ‚Ð²ÐµÐ½ÑÐºÐ¸Ð¹ Ð¿Ð¾ÑÑ‚ (28 Ð½Ð¾Ñ - 6 ÑÐ½Ð²) ---
        // Ð£Ñ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´ Ð³Ð¾Ð´Ð°. Ð•ÑÐ»Ð¸ ÑÐµÐ¹Ñ‡Ð°Ñ ÑÐ½Ð²Ð°Ñ€ÑŒ, ÑÐ¼Ð¾Ñ‚Ñ€Ð¸Ð¼ Ð¿Ð¾ÑÑ‚ Ð½Ð°Ñ‡Ð°Ð²ÑˆÐ¸Ð¹ÑÑ Ð² Ð¿Ñ€Ð¾ÑˆÐ»Ð¾Ð¼ Ð³Ð¾Ð´Ñƒ.
        // ÐŸÑ€Ð¾Ñ‰Ðµ Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ÑŒ Ð´Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½Ñ‹.
        $isChristmasFast = 
            ($md >= '11-28' && $md <= '12-31') || 
            ($md >= '01-01' && $md <= '01-06');

        if ($isChristmasFast) {
            $food = "ÐŸÐ¾ÑÑ‚Ð½Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ.";
            // Ð£Ð¿Ñ€Ð¾Ñ‰ÐµÐ½Ð½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°: Ð Ñ‹Ð±Ð° Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð° Ð² Ð¡Ð± Ð¸ Ð’Ñ, Ð¸ Ð² Ð¿Ñ€Ð°Ð·Ð´Ð½Ð¸ÐºÐ¸
            if ($dayOfWeek === 6 || $dayOfWeek === 7 || $md === '12-04' || $md === '12-19') {
                $food .= " Ð Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÑ‚ÑÑ Ñ€Ñ‹Ð±Ð°.";
            } elseif ($dayOfWeek === 2 || $dayOfWeek === 4) {
                $food .= " ÐŸÐ¸Ñ‰Ð° Ñ Ð¼Ð°ÑÐ»Ð¾Ð¼.";
            } else {
                $food .= " Ð¡ÑƒÑ…Ð¾ÑÐ´ÐµÐ½Ð¸Ðµ Ð¸Ð»Ð¸ Ð¿Ð¸Ñ‰Ð° Ð±ÐµÐ· Ð¼Ð°ÑÐ»Ð° (Ð¼Ð¾Ð½Ð°ÑÑ‚Ñ‹Ñ€ÑÐºÐ¸Ð¹ ÑƒÑÑ‚Ð°Ð²).";
            }
            
            // Ð¡Ñ‚Ñ€Ð¾Ð³Ð¸Ðµ Ð´Ð½Ð¸ Ð¿Ñ€ÐµÐ´Ð¿Ñ€Ð°Ð·Ð´Ð½ÑÑ‚Ð²Ð° (2-6 ÑÐ½Ð²Ð°Ñ€Ñ)
            if ($md >= '01-02' && $md <= '01-06') {
                $food = "Ð¡Ñ‚Ñ€Ð¾Ð³Ð¸Ð¹ Ð¿Ð¾ÑÑ‚ Ð¿ÐµÑ€ÐµÐ´ Ð Ð¾Ð¶Ð´ÐµÑÑ‚Ð²Ð¾Ð¼.";
            }

            return "Ð Ð¾Ð¶Ð´ÐµÑÑ‚Ð²ÐµÐ½ÑÐºÐ¸Ð¹ Ð¿Ð¾ÑÑ‚. " . $food;
        }

        // --- Ð£ÑÐ¿ÐµÐ½ÑÐºÐ¸Ð¹ Ð¿Ð¾ÑÑ‚ (14 Ð°Ð²Ð³ - 27 Ð°Ð²Ð³) ---
        if ($md >= '08-14' && $md <= '08-27') {
            $food = ($md === '08-19') ? "Ð Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÑ‚ÑÑ Ñ€Ñ‹Ð±Ð° (ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ðµ)." : "Ð¡Ñ‚Ñ€Ð¾Ð³Ð¸Ð¹ Ð¿Ð¾ÑÑ‚.";
            return "Ð£ÑÐ¿ÐµÐ½ÑÐºÐ¸Ð¹ Ð¿Ð¾ÑÑ‚. " . $food;
        }

        // --- ÐŸÐµÑ‚Ñ€Ð¾Ð² Ð¿Ð¾ÑÑ‚ (Ñ‡ÐµÑ€ÐµÐ· Ð½ÐµÐ´ÐµÐ»ÑŽ Ð¿Ð¾ÑÐ»Ðµ Ð¢Ñ€Ð¾Ð¸Ñ†Ñ‹ Ð´Ð¾ 11 Ð¸ÑŽÐ»Ñ) ---
        // Ð¢Ñ€Ð¾Ð¸Ñ†Ð° + 8 Ð´Ð½ÐµÐ¹ = ÐÐ°Ñ‡Ð°Ð»Ð¾ Ð¿Ð¾ÑÑ‚Ð°
        $pentecostTs = $easterTs + (49 * 86400);
        $petrovStart = $pentecostTs + (8 * 86400); 
        // ÐšÐ¾Ð½ÐµÑ† 11 Ð¸ÑŽÐ»Ñ (Ñ„Ð¸ÐºÑÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹)
        $petrovEnd = mktime(0, 0, 0, 7, 11, $year);

        if ($currentTs >= $petrovStart && $currentTs <= $petrovEnd) {
            return "ÐŸÐµÑ‚Ñ€Ð¾Ð² Ð¿Ð¾ÑÑ‚. Ð Ð°Ð·Ñ€ÐµÑˆÐ°ÐµÑ‚ÑÑ Ñ€Ñ‹Ð±Ð° (ÐºÑ€Ð¾Ð¼Ðµ ÑÑ€ÐµÐ´Ñ‹ Ð¸ Ð¿ÑÑ‚Ð½Ð¸Ñ†Ñ‹).";
        }

        // --- Ð’ÐµÐ»Ð¸ÐºÐ¸Ð¹ Ð¿Ð¾ÑÑ‚ (Ð·Ð° 48 Ð´Ð½ÐµÐ¹ Ð´Ð¾ ÐŸÐ°ÑÑ…Ð¸) ---
        $diffEaster = ($currentTs - $easterTs) / 86400;
        if ($diffEaster >= -48 && $diffEaster < 0) {
            return "Ð’ÐµÐ»Ð¸ÐºÐ¸Ð¹ Ð¿Ð¾ÑÑ‚. Ð¡Ñ‚Ñ€Ð¾Ð³Ð¾Ðµ Ð²Ð¾Ð·Ð´ÐµÑ€Ð¶Ð°Ð½Ð¸Ðµ.";
        }

        // --- Ð¡Ñ€ÐµÐ´Ð° Ð¸ ÐŸÑÑ‚Ð½Ð¸Ñ†Ð° (ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ Ð¿Ð¾ÑÑ‚Ð° Ð¸ Ð½Ðµ ÑÐ¿Ð»Ð¾ÑˆÐ½Ð°Ñ ÑÐµÐ´Ð¼Ð¸Ñ†Ð°) ---
        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° ÑÐ¿Ð»Ð¾ÑˆÐ½Ñ‹Ðµ ÑÐµÐ´Ð¼Ð¸Ñ†Ñ‹ (Ð¡Ð²ÑÑ‚ÐºÐ¸, Ð¡Ð²ÐµÑ‚Ð»Ð°Ñ, Ð¢Ñ€Ð¾Ð¸Ñ†ÐºÐ°Ñ Ð¸ Ñ‚.Ð´.) Ð¾Ð¿ÑƒÑ‰ÐµÐ½Ð° Ð´Ð»Ñ ÐºÑ€Ð°Ñ‚ÐºÐ¾ÑÑ‚Ð¸,
        // Ð½Ð¾ Ð±Ð°Ð·Ð¾Ð²Ð¾Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð¾ ÑÑ€ÐµÐ´Ñ‹ Ð¸ Ð¿ÑÑ‚Ð½Ð¸Ñ†Ñ‹ Ð´Ð¾Ð±Ð°Ð²Ð¸Ð¼.
        if (!$isChristmasFast && ($dayOfWeek === 3 || $dayOfWeek === 5)) {
            // Ð˜ÑÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ (Ð¡Ð²ÑÑ‚ÐºÐ¸ 7-17 ÑÐ½Ð²)
            if (!($md >= '01-07' && $md <= '01-17')) {
                return "ÐŸÐ¾ÑÑ‚Ð½Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ (Ð¡Ñ€ÐµÐ´Ð°/ÐŸÑÑ‚Ð½Ð¸Ñ†Ð°).";
            }
        }

        return null;
    }

    /**
     * Ð Ð°ÑÑ‡ÐµÑ‚ ÐŸÐ°ÑÑ…Ð¸ (ÐÐ»ÐµÐºÑÐ°Ð½Ð´Ñ€Ð¸Ð¹ÑÐºÐ°Ñ Ð¿Ð°ÑÑ…Ð°Ð»Ð¸Ñ)
     */
    private function getOrthodoxEasterTimestamp(int $year): int
    {
        $a = $year % 19;
        $b = $year % 4;
        $c = $year % 7;
        $d = (19 * $a + 15) % 30;
        $e = (2 * $b + 4 * $c + 6 * $d + 6) % 7;
        $f = $d + $e;
        $day = 4 + $f;
        return mktime(0, 0, 0, 4, $day + 13, $year);
    }
}
